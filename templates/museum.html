<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Museum Stories â€” Post Manager</title>
<style>
  :root {
    --bg: #0a0a0a; --surface: #141414; --surface2: #1a1a1a; --surface3: #222;
    --border: #2a2a2a; --border2: #333; --text: #e0e0e0; --text2: #999; --text3: #666;
    --blue: #1d9bf0; --green: #4caf50; --orange: #f0a020; --red: #e53935; --purple: #9c27b0;
    --yellow: #ffd600;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }

  /* === TOP BAR === */
  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 16px 32px; display: flex; align-items: center; gap: 16px;
  }
  .topbar h1 { font-size: 18px; font-weight: 600; color: #fff; white-space: nowrap; }
  .topbar .stats { font-size: 12px; color: var(--text2); display: flex; gap: 12px; }
  .topbar .stats span { white-space: nowrap; }
  .topbar .spacer { flex: 1; }
  .topbar button {
    font-size: 12px; padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border2);
    background: transparent; color: var(--text2); cursor: pointer;
  }
  .topbar button:hover { border-color: var(--blue); color: var(--blue); }
  .topbar button.primary { background: var(--blue); border-color: var(--blue); color: #fff; }

  /* === FILTERS === */
  .filters {
    padding: 12px 32px; background: var(--surface); border-bottom: 1px solid var(--border);
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
  }
  .filter-group { display: flex; gap: 4px; align-items: center; }
  .filter-group .label { font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-right: 4px; }
  .filter-pill {
    font-size: 11px; padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border2);
    background: transparent; color: var(--text2); cursor: pointer; white-space: nowrap;
  }
  .filter-pill:hover { border-color: var(--blue); color: var(--blue); }
  .filter-pill.active { background: var(--blue); border-color: var(--blue); color: #fff; }
  .filter-sep { width: 1px; height: 20px; background: var(--border); margin: 0 8px; }
  .search-input {
    font-size: 12px; padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border2);
    background: var(--surface2); color: var(--text); outline: none; width: 200px;
  }
  .search-input:focus { border-color: var(--blue); }

  /* === POST LIST === */
  .post-list { padding: 16px 32px 60px; }

  .post-row {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    margin-bottom: 8px; overflow: hidden; transition: border-color 0.2s;
  }
  .post-row:hover { border-color: var(--border2); }
  .post-row.expanded { border-color: var(--blue); margin-bottom: 16px; }

  .post-summary {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer;
    user-select: none;
  }
  .post-summary:hover { background: var(--surface2); }

  .state-badge {
    font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 3px 8px; border-radius: 4px; cursor: pointer; white-space: nowrap;
  }
  .state-draft { background: #2a2a2a; color: #888; }
  .state-review { background: #2a2a1a; color: var(--orange); }
  .state-approved { background: #1a2a1a; color: var(--green); }
  .state-scheduled { background: #1a1a2a; color: var(--purple); }
  .state-posted { background: #1a2a2a; color: var(--blue); }

  .format-badge {
    font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 2px 6px;
    border-radius: 3px; white-space: nowrap;
  }
  .fmt-thread { background: #1d3a5c; color: var(--blue); }
  .fmt-single { background: #2d3a1c; color: #8bc34a; }

  .post-summary .title { font-size: 14px; color: #fff; font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .post-summary .source { font-size: 11px; color: var(--text3); white-space: nowrap; }
  .post-summary .img-count { font-size: 11px; color: var(--text3); white-space: nowrap; }
  .post-summary .preview { font-size: 12px; color: var(--text2); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .post-summary .expand-arrow { font-size: 14px; color: var(--text3); transition: transform 0.2s; }
  .post-row.expanded .expand-arrow { transform: rotate(90deg); }

  /* === EXPANDED POST === */
  .post-detail { display: none; border-top: 1px solid var(--border); }
  .post-row.expanded .post-detail { display: block; }

  .post-detail-inner { display: flex; gap: 0; }

  /* Image panel */
  .img-panel {
    width: 420px; min-width: 420px; background: #0d0d0d; padding: 16px;
    border-right: 1px solid var(--border); max-height: 700px; overflow-y: auto;
  }
  .img-panel-header { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
  .img-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .img-cell {
    position: relative; border-radius: 6px; overflow: hidden; cursor: pointer;
    border: 2px solid transparent; transition: border-color 0.2s; aspect-ratio: 4/3;
  }
  .img-cell img { width: 100%; height: 100%; object-fit: cover; }
  .img-cell:hover { border-color: var(--blue); }
  .img-cell.selected { border-color: var(--blue); }
  .img-cell .img-idx {
    position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7);
    color: #fff; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 3px;
  }
  .img-cell .img-size {
    position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7);
    color: var(--text2); font-size: 9px; padding: 1px 5px; border-radius: 3px;
  }
  /* Tweet assignment badges on images */
  .img-cell .tweet-badges {
    position: absolute; top: 4px; right: 4px; display: flex; gap: 2px;
  }
  .img-cell .tweet-badge {
    background: var(--blue); color: #fff; font-size: 8px; font-weight: 700;
    padding: 1px 4px; border-radius: 3px;
  }
  /* Pick mode overlay */
  .img-cell.pick-target { cursor: crosshair; }
  .img-cell.pick-target::after {
    content: '+'; position: absolute; inset: 0; display: flex;
    align-items: center; justify-content: center;
    background: rgba(29,155,240,0.15); color: var(--blue);
    font-size: 32px; font-weight: 700; opacity: 0; transition: opacity 0.15s;
  }
  .img-cell.pick-target:hover::after { opacity: 1; }
  .img-cell.pick-target:hover { border-color: var(--green); }

  /* Copy panel */
  .copy-panel { flex: 1; padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; }

  .tweet-editor {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 14px; position: relative;
  }
  .tweet-editor .tweet-label {
    font-size: 10px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
  }
  .tweet-editor .tweet-text {
    font-size: 14px; line-height: 1.5; color: var(--text); white-space: pre-wrap;
    min-height: 60px; outline: none; border-radius: 4px; padding: 4px; margin: -4px;
  }
  .tweet-editor .tweet-text:focus { background: #1a2a3a; outline: 1px solid var(--blue); }
  .tweet-editor .tweet-meta {
    display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap;
  }
  .tweet-editor .char-ct { font-size: 11px; color: var(--text3); }
  .tweet-editor .char-ct.over { color: var(--red); }
  .tweet-editor .img-tags { display: flex; gap: 4px; flex-wrap: wrap; }
  .img-tag {
    font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #1d3a5c;
    color: var(--blue); display: flex; align-items: center; gap: 4px;
  }
  .img-tag .remove { cursor: pointer; opacity: 0.6; }
  .img-tag .remove:hover { opacity: 1; }
  .add-img-btn {
    font-size: 10px; padding: 2px 8px; border-radius: 10px; border: 1px dashed var(--border2);
    background: transparent; color: var(--text3); cursor: pointer;
  }
  .add-img-btn:hover { border-color: var(--blue); color: var(--blue); }
  .add-img-btn.picking { border-color: var(--blue); background: rgba(29,155,240,0.15); color: var(--blue); }

  /* Post footer */
  .post-actions {
    padding: 12px 16px; border-top: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .state-select {
    font-size: 12px; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border2);
    background: var(--surface2); color: var(--text); outline: none; cursor: pointer;
  }
  .feedback-notes {
    flex: 1; font-size: 12px; padding: 7px 12px; border-radius: 6px; border: 1px solid var(--border2);
    background: var(--surface2); color: var(--text); outline: none;
  }
  .feedback-notes:focus { border-color: var(--blue); }
  .vote-btn-sm {
    font-size: 18px; background: none; border: none; cursor: pointer; opacity: 0.4;
    transition: opacity 0.2s;
  }
  .vote-btn-sm:hover { opacity: 0.8; }
  .vote-btn-sm.active { opacity: 1; }

  /* Lightbox */
  .lightbox {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    z-index: 1000; justify-content: center; align-items: center; cursor: pointer;
  }
  .lightbox.active { display: flex; }
  .lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 4px; }
  .lightbox .close { position: absolute; top: 20px; right: 24px; color: #fff; font-size: 28px; cursor: pointer; opacity: 0.7; }
  .lightbox .close:hover { opacity: 1; }

  /* Toast */
  .toast {
    position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #2a2a2a;
    border: 1px solid #444; border-radius: 6px; font-size: 13px; display: none; z-index: 100;
    color: var(--text);
  }

  @media (max-width: 1000px) {
    .post-detail-inner { flex-direction: column; }
    .img-panel { width: 100%; min-width: 0; max-height: 300px; border-right: none; border-bottom: 1px solid var(--border); }
    .post-summary .preview { display: none; }
  }
</style>
</head>
<body>

<div class="topbar">
  <h1>Museum Stories</h1>
  <div class="stats" id="stats"></div>
  <div class="spacer"></div>
  <button onclick="expandAll()">Expand All</button>
  <button onclick="collapseAll()">Collapse All</button>
  <button class="primary" onclick="exportData()">Export JSON</button>
</div>

<div class="filters">
  <div class="filter-group">
    <span class="label">State</span>
    <button class="filter-pill active" data-filter="state" data-val="all" onclick="setFilter(this)">All</button>
    <button class="filter-pill" data-filter="state" data-val="draft" onclick="setFilter(this)">Draft</button>
    <button class="filter-pill" data-filter="state" data-val="review" onclick="setFilter(this)">Review</button>
    <button class="filter-pill" data-filter="state" data-val="approved" onclick="setFilter(this)">Approved</button>
    <button class="filter-pill" data-filter="state" data-val="posted" onclick="setFilter(this)">Posted</button>
  </div>
  <div class="filter-sep"></div>
  <div class="filter-group">
    <span class="label">Format</span>
    <button class="filter-pill active" data-filter="format" data-val="all" onclick="setFilter(this)">All</button>
    <button class="filter-pill" data-filter="format" data-val="thread" onclick="setFilter(this)">Threads</button>
    <button class="filter-pill" data-filter="format" data-val="single" onclick="setFilter(this)">Singles</button>
  </div>
  <div class="filter-sep"></div>
  <input class="search-input" placeholder="Search posts..." oninput="applyFilters()" id="searchInput">
</div>

<div class="post-list" id="postList"></div>

<div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
  <span class="close">&times;</span>
  <img id="lightboxImg" src="" alt="">
</div>

<div class="toast" id="toast"></div>

<script>
const STATES = ['draft', 'review', 'approved', 'posted'];
const posts = __POSTS_DATA__;

// === Pick mode state ===
let pickMode = null; // { postId, tweetIndex } or null

// === API helpers ===
async function api(endpoint, body) {
  const r = await fetch('/museum/api/' + endpoint, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  return r.json();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.style.display = 'none', 2000);
}

// === Filters ===
let filters = { state: 'all', format: 'all', search: '' };

function setFilter(btn) {
  const group = btn.dataset.filter;
  filters[group] = btn.dataset.val;
  btn.closest('.filter-group').querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  applyFilters();
}

function applyFilters() {
  filters.search = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.post-row').forEach(row => {
    const post = posts.find(p => p.id === parseInt(row.dataset.id));
    const state = post.status || 'draft';
    let show = true;
    if (filters.state !== 'all' && state !== filters.state) show = false;
    if (filters.format !== 'all' && post.format !== filters.format) show = false;
    if (filters.search && !post.title.toLowerCase().includes(filters.search) && !post.artist.toLowerCase().includes(filters.search)) show = false;
    row.style.display = show ? '' : 'none';
  });
}

// === Rendering ===
function render() {
  const list = document.getElementById('postList');
  list.innerHTML = '';
  posts.forEach(post => {
    const state = post.status || 'draft';
    const row = document.createElement('div');
    row.className = 'post-row';
    row.dataset.id = post.id;

    const firstTweet = post.tweets[0].text;
    const preview = firstTweet.replace(/\n/g, ' ').slice(0, 80);

    row.innerHTML =
      '<div class="post-summary" onclick="togglePost(' + post.id + ')">' +
        '<span class="state-badge state-' + state + '" onclick="event.stopPropagation();cycleState(' + post.id + ')" title="Click to change state">' + state + '</span>' +
        '<span class="format-badge fmt-' + post.format + '">' + post.format + (post.format === 'thread' ? ' ' + post.tweets.length : '') + '</span>' +
        '<span class="title">' + escHtml(post.title) + '</span>' +
        '<span class="source">' + escHtml(post.source) + '</span>' +
        '<span class="img-count">' + post.allImages.length + ' imgs</span>' +
        '<span class="preview">' + escHtml(preview) + '</span>' +
        '<span class="expand-arrow">\u25b8</span>' +
      '</div>' +
      '<div class="post-detail">' + renderDetail(post) + '</div>';

    list.appendChild(row);
  });
  updateStats();
  applyFilters();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function renderDetail(post) {
  // Build a map: which images are used by which tweets
  const imgUsage = {};
  post.tweets.forEach((t, ti) => {
    (t.images || []).forEach(idx => {
      if (!imgUsage[idx]) imgUsage[idx] = [];
      imgUsage[idx].push(ti);
    });
  });

  // Image grid
  let imgGrid = '';
  post.allImages.forEach((url, i) => {
    const inPick = pickMode && pickMode.postId === post.id;
    const pickClass = inPick ? ' pick-target' : '';
    const usedClass = imgUsage[i] ? ' selected' : '';
    const badges = imgUsage[i] ? '<div class="tweet-badges">' +
      imgUsage[i].map(ti => '<span class="tweet-badge">T' + (ti+1) + '</span>').join('') +
      '</div>' : '';

    const clickHandler = inPick
      ? 'pickImage(' + post.id + ',' + i + ')'
      : 'openLightbox(\'' + url.replace(/'/g, "\\'") + '\')';

    imgGrid += '<div class="img-cell' + usedClass + pickClass + '" onclick="' + clickHandler + '">' +
      '<img src="' + url + '" loading="lazy" alt="Image ' + (i+1) + '">' +
      '<span class="img-idx">' + (i+1) + '</span>' +
      badges +
    '</div>';
  });

  // Tweet editors
  let tweetEditors = '';
  post.tweets.forEach((tweet, i) => {
    const text = tweet.text;
    const charCount = text.length;
    const imgTags = (tweet.images || []).map(idx =>
      '<span class="img-tag">img ' + (idx+1) + ' <span class="remove" onclick="removeImg(' + post.id + ',' + i + ',' + idx + ')">\u00d7</span></span>'
    ).join('');

    const isPicking = pickMode && pickMode.postId === post.id && pickMode.tweetIndex === i;
    const addBtnClass = isPicking ? 'add-img-btn picking' : 'add-img-btn';
    const addBtnText = isPicking ? 'picking...' : '+ img';

    tweetEditors +=
      '<div class="tweet-editor">' +
        '<div class="tweet-label">' + (post.format === 'thread' ? 'Tweet ' + (i+1) + '/' + post.tweets.length : 'Tweet') + '</div>' +
        '<div class="tweet-text" contenteditable="true" data-post="' + post.id + '" data-idx="' + i + '">' + escHtml(text) + '</div>' +
        '<div class="tweet-meta">' +
          '<span class="char-ct ' + (charCount > 280 ? 'over' : '') + '">' + charCount + '/280</span>' +
          '<div class="img-tags">' + imgTags + '</div>' +
          '<button class="' + addBtnClass + '" onclick="togglePickMode(' + post.id + ',' + i + ')">' + addBtnText + '</button>' +
        '</div>' +
      '</div>';
  });

  // Object info
  const info = '<div style="font-size:11px;color:var(--text3);padding:4px 0 8px;display:flex;gap:16px;flex-wrap:wrap;">' +
    '<span>' + escHtml(post.artist) + '</span><span>' + escHtml(post.medium) + '</span><span>' + escHtml(post.dimensions) + '</span></div>';

  const notes = post.notes || '';
  const vote = post.vote || '';
  const state = post.status || 'draft';

  return '<div class="post-detail-inner">' +
    '<div class="img-panel">' +
      '<div class="img-panel-header">All images (' + post.allImages.length + ')</div>' +
      '<div class="img-grid">' + imgGrid + '</div>' +
    '</div>' +
    '<div class="copy-panel">' + info + tweetEditors + '</div>' +
  '</div>' +
  '<div class="post-actions">' +
    '<select class="state-select" onchange="setState(' + post.id + ',this.value)">' +
      STATES.map(function(st) { return '<option value="' + st + '"' + (st === state ? ' selected' : '') + '>' + st.charAt(0).toUpperCase() + st.slice(1) + '</option>'; }).join('') +
    '</select>' +
    '<span class="vote-btn-sm ' + (vote==='up'?'active':'') + '" onclick="setVote(' + post.id + ',\'up\')">\ud83d\udc4d</span>' +
    '<span class="vote-btn-sm ' + (vote==='down'?'active':'') + '" onclick="setVote(' + post.id + ',\'down\')">\ud83d\udc4e</span>' +
    '<input class="feedback-notes" placeholder="Notes..." value="' + (notes||'').replace(/"/g,'&quot;') + '" oninput="saveNotes(' + post.id + ',this.value)">' +
  '</div>';
}

// === Interactions ===
function togglePost(id) {
  const row = document.querySelector('[data-id="' + id + '"]');
  row.classList.toggle('expanded');
}

function expandAll() { document.querySelectorAll('.post-row').forEach(r => r.classList.add('expanded')); }
function collapseAll() { document.querySelectorAll('.post-row').forEach(r => r.classList.remove('expanded')); }

function cycleState(id) {
  const post = posts.find(p => p.id === id);
  const cur = post.status || 'draft';
  const idx = STATES.indexOf(cur);
  const next = STATES[(idx + 1) % STATES.length];
  setState(id, next);
}

async function setState(id, state) {
  const res = await api('status', { id: id, status: state });
  if (res.ok) {
    const post = posts.find(p => p.id === id);
    post.status = state;
    showToast('#' + id + ' \u2192 ' + state);
    render();
  }
}

async function setVote(id, vote) {
  const post = posts.find(p => p.id === id);
  const newVote = post.vote === vote ? null : vote;
  const res = await api('notes', { id: id, vote: newVote, notes: post.notes || '' });
  if (res.ok) {
    post.vote = newVote;
    showToast('#' + id + ' vote ' + (newVote || 'cleared'));
    render();
  }
}

let notesTimer = null;
function saveNotes(id, val) {
  const post = posts.find(p => p.id === id);
  post.notes = val;
  clearTimeout(notesTimer);
  notesTimer = setTimeout(async () => {
    await api('notes', { id: id, vote: post.vote, notes: val });
  }, 500);
}

// === Image assignment (pick mode) ===
function togglePickMode(postId, tweetIndex) {
  if (pickMode && pickMode.postId === postId && pickMode.tweetIndex === tweetIndex) {
    pickMode = null;
  } else {
    pickMode = { postId, tweetIndex };
  }
  render();
  // Re-expand the post
  const row = document.querySelector('[data-id="' + postId + '"]');
  if (row) row.classList.add('expanded');
}

async function pickImage(postId, imageIndex) {
  if (!pickMode || pickMode.postId !== postId) return;
  const res = await api('image-assign', {
    post_id: postId,
    tweet_index: pickMode.tweetIndex,
    image_index: imageIndex,
    action: 'add'
  });
  if (res.ok) {
    const post = posts.find(p => p.id === postId);
    const tweet = post.tweets[pickMode.tweetIndex];
    if (!tweet.images) tweet.images = [];
    if (!tweet.images.includes(imageIndex)) {
      tweet.images.push(imageIndex);
    }
    showToast('img ' + (imageIndex+1) + ' \u2192 tweet ' + (pickMode.tweetIndex+1));
    render();
    // Stay in pick mode, re-expand
    const row = document.querySelector('[data-id="' + postId + '"]');
    if (row) row.classList.add('expanded');
  }
}

async function removeImg(postId, tweetIdx, imgIdx) {
  const res = await api('image-assign', {
    post_id: postId,
    tweet_index: tweetIdx,
    image_index: imgIdx,
    action: 'remove'
  });
  if (res.ok) {
    const post = posts.find(p => p.id === postId);
    post.tweets[tweetIdx].images = post.tweets[tweetIdx].images.filter(i => i !== imgIdx);
    showToast('removed img ' + (imgIdx+1) + ' from tweet ' + (tweetIdx+1));
    render();
    // Re-expand
    const row = document.querySelector('[data-id="' + postId + '"]');
    if (row) row.classList.add('expanded');
  }
}

// === Inline editing ===
let editTimer = null;
document.addEventListener('input', function(e) {
  if (e.target.classList.contains('tweet-text') && e.target.contentEditable === 'true') {
    const postId = parseInt(e.target.dataset.post);
    const idx = parseInt(e.target.dataset.idx);
    const text = e.target.innerText;
    // Update local state
    const post = posts.find(p => p.id === postId);
    post.tweets[idx].text = text;
    // Update char count
    const ct = e.target.closest('.tweet-editor').querySelector('.char-ct');
    if (ct) { ct.textContent = text.length + '/280'; ct.className = 'char-ct' + (text.length > 280 ? ' over' : ''); }
    // Debounced save
    clearTimeout(editTimer);
    editTimer = setTimeout(async () => {
      await api('tweet-edit', { id: postId, tweet_index: idx, text: text });
    }, 500);
  }
});

// Click outside to exit pick mode
document.addEventListener('click', function(e) {
  if (!pickMode) return;
  if (e.target.closest('.img-cell') || e.target.closest('.add-img-btn')) return;
  pickMode = null;
  render();
  // Re-expand all previously expanded
  document.querySelectorAll('.post-row').forEach(r => {
    if (r.dataset.wasExpanded) { r.classList.add('expanded'); delete r.dataset.wasExpanded; }
  });
});

// === Stats ===
function updateStats() {
  const counts = { draft: 0, review: 0, approved: 0, posted: 0 };
  posts.forEach(p => { const st = p.status || 'draft'; counts[st] = (counts[st]||0) + 1; });
  document.getElementById('stats').innerHTML =
    '<span>' + posts.length + ' posts</span>' +
    '<span>Draft: ' + counts.draft + '</span>' +
    '<span>Review: ' + counts.review + '</span>' +
    '<span style="color:var(--green)">Approved: ' + counts.approved + '</span>' +
    '<span style="color:var(--blue)">Posted: ' + counts.posted + '</span>';
}

// === Lightbox ===
function openLightbox(url) {
  document.getElementById('lightboxImg').src = url;
  document.getElementById('lightbox').classList.add('active');
}
function closeLightbox(e) {
  if (e.target === document.getElementById('lightbox') || e.target.classList.contains('close'))
    document.getElementById('lightbox').classList.remove('active');
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') document.getElementById('lightbox').classList.remove('active');
});

// === Export ===
function exportData() {
  const data = { exported: new Date().toISOString(), posts: posts };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'museum_posts_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}

// === Init ===
render();
</script>
</body>
</html>
